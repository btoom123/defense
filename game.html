<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Thẻ Meta cho SEO và chia sẻ mạng xã hội khi host trên Vercel -->
    <meta name="description" content="Thủ Thành Vô Hạn - Game chiến thuật phòng thủ tháp hấp dẫn trên trình duyệt.">
    <meta property="og:title" content="Thủ Thành Vô Hạn">
    <meta property="og:description" content="Bảo vệ tường thành, triệu hồi tướng và chiến đấu chống lại quái vật vô tận!">
    <meta property="og:type" content="website">
    <title>Thủ Thành Vô Hạn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; color: white; user-select: none; display: flex; align-items: center; justify-content: center; height: 100vh; touch-action: none; }
        
        #game-wrapper {
            position: relative;
            width: 100%;
            max-width: 177.78vh; /* 16/9 aspect ratio */
            aspect-ratio: 16/9;
            background: #1a202c;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        canvas { display: block; width: 100%; height: 100%; touch-action: none; }
        
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; }
        
        .ui-panel {
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid #4b5563;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(4px);
        }

        .screen-overlay {
            position: absolute;
            inset: 0;
            background: rgba(17, 24, 39, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        /* Gallery Styles */
        .gallery-container {
            width: 90%;
            max-width: 900px;
            height: 80vh;
            background: #2d3748;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #4a5568;
        }
        
        .gallery-tabs {
            display: flex;
            background: #1a202c;
            padding: 0.5rem;
            gap: 0.5rem;
        }
        
        .gallery-tab {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: bold;
            color: #a0aec0;
            transition: all 0.2s;
        }
        .gallery-tab.active { background: #4a5568; color: white; }
        .gallery-tab:hover { background: #2d3748; }

        .gallery-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }

        .card {
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s;
            position: relative;
        }
        .card:hover { transform: translateY(-5px); border-color: #63b3ed; }
        .card.locked { opacity: 0.5; filter: grayscale(1); }
        .card.selected { border: 2px solid #48bb78; box-shadow: 0 0 10px #48bb78; }

        /* Gacha Wheel Styles */
        .gacha-wheel-container {
            position: relative;
            width: 400px; 
            height: 400px;
            border-radius: 50%;
            border: 10px solid #d69e2e;
            box-shadow: 0 0 30px rgba(214, 158, 46, 0.5);
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .gacha-wheel-bg {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(
                #f56565 0% 10%, #ed8936 10% 20%, #ecc94b 20% 30%, #48bb78 30% 40%, 
                #38b2ac 40% 50%, #4299e1 50% 60%, #667eea 60% 70%, #9f7aea 70% 80%, 
                #ed64a6 80% 90%, #a0aec0 90% 100%
            );
        }

        .wheel-content {
            position: absolute;
            top: 30px;
            transform: translateX(-50%);
            left: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .wheel-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
            transform: rotate(180deg); 
        }

        .gacha-pointer {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid white;
            z-index: 10;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.5));
        }
        
        .gacha-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 60px; height: 60px;
            background: white;
            border-radius: 50%;
            border: 4px solid #d69e2e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #d69e2e;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
            z-index: 5;
        }

        /* Skill Buttons - Updated for smaller size */
        .skill-btn {
            position: relative;
            width: 50px; height: 50px; /* Reduced from 60px */
            border-radius: 50%;
            border: 3px solid #718096;
            background: #2d3748;
            display: flex;
            align-items: center; justify-content: center;
            font-size: 1.2rem; /* Reduced from 1.5rem */
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .skill-btn:hover:not(:disabled) { transform: scale(1.1); border-color: white; }
        .skill-btn:active:not(:disabled) { transform: scale(0.95); }
        .skill-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .skill-cooldown {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; font-weight: bold;
            display: none;
        }
        .skill-cost {
            position: absolute; bottom: -18px;
            background: rgba(0,0,0,0.8);
            padding: 1px 4px; border-radius: 4px;
            font-size: 0.65rem; font-weight: bold;
            color: #ecc94b;
            white-space: nowrap;
        }

        #frenzy-overlay {
            position: absolute; inset: 0;
            background: radial-gradient(circle, transparent 50%, rgba(255, 0, 0, 0.2) 100%);
            pointer-events: none;
            display: none;
            z-index: 5;
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

    </style>
</head>
<body>

<div id="game-wrapper">
    <!-- Visual Effect Overlay -->
    <div id="frenzy-overlay"></div>

    <!-- Header Stats -->
    <div class="absolute top-0 left-0 right-0 h-16 flex items-center justify-between px-6 bg-gray-900/90 border-b border-gray-700 z-10">
        <div id="ingame-stats" class="flex gap-6 text-lg font-bold hidden">
            <span class="text-yellow-400"><i class="fas fa-coins mr-2"></i><span id="ui-gold">0</span></span>
            <span class="text-blue-400"><i class="fas fa-layer-group mr-2"></i>Wave: <span id="ui-wave">1</span></span>
            <span class="text-green-400"><i class="fas fa-shield-alt mr-2"></i>Wall: <span id="ui-wall-hp">1000</span>/<span id="ui-max-wall-hp">1000</span></span>
        </div>
        
        <div class="flex gap-6 text-lg font-bold">
             <span class="text-gray-300 border border-gray-600 px-3 py-1 rounded bg-gray-800 cursor-pointer hover:bg-gray-700 transition" onclick="showSilverInfo()"><i class="fas fa-gem mr-2 text-teal-400"></i>Bạc: <span id="ui-silver">0</span></span>
        </div>

        <div class="text-center flex-1 flex justify-center items-center gap-4">
            <span id="ui-timer" class="text-red-500 font-mono text-2xl animate-pulse hidden">Tiếp: 30s</span>
            <button id="btn-skip" class="hidden px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-sm font-bold shadow-lg">VÀO TRẬN NGAY</button>
        </div>
        
        <div class="flex gap-3">
            <button id="btn-speed" onclick="toggleSpeed()" class="hidden w-12 h-10 flex items-center justify-center bg-blue-700 hover:bg-blue-600 rounded text-sm border border-blue-500 font-bold shadow transition">x1</button>
            <button id="btn-surrender" onclick="forceGameOver()" class="hidden px-4 py-2 bg-red-800 hover:bg-red-700 rounded text-sm border border-red-600 shadow" title="Đầu hàng"><i class="fas fa-flag"></i></button>
            <button id="btn-pause" class="hidden px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm shadow"><i class="fas fa-pause"></i></button>
        </div>
    </div>

    <!-- Main Game Canvas -->
    <canvas id="gameCanvas" width="1920" height="1080"></canvas>
    
    <!-- Start Screen -->
    <div id="start-screen" class="screen-overlay">
        <h1 class="text-7xl font-bold text-yellow-500 mb-4 uppercase tracking-widest text-center drop-shadow-lg">Thủ Thành Vô Hạn</h1>
        <p class="text-gray-400 text-xl mb-12 text-center">Bảo vệ tường thành khỏi những đợt tấn công bất tận</p>
        
        <div class="flex gap-6">
            <button onclick="startGame()" class="px-10 py-5 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-2xl shadow-xl transition-transform hover:scale-105 flex items-center">
                <i class="fas fa-play mr-3"></i> BẮT ĐẦU
            </button>
            <button onclick="showGallery()" class="px-10 py-5 bg-purple-600 hover:bg-purple-500 rounded-xl font-bold text-2xl shadow-xl transition-transform hover:scale-105 flex items-center">
                <i class="fas fa-book mr-3"></i> THƯ VIỆN
            </button>
            <button onclick="showGacha()" class="px-10 py-5 bg-teal-600 hover:bg-teal-500 rounded-xl font-bold text-2xl shadow-xl transition-transform hover:scale-105 flex items-center">
                <i class="fas fa-dharmachakra mr-3"></i> GACHA
            </button>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div id="gallery-screen" class="screen-overlay hidden bg-gray-900/95">
        <div class="bg-gray-800 border border-gray-600 w-3/4 h-3/4 rounded-2xl flex flex-col overflow-hidden shadow-2xl">
            <div class="flex justify-between items-center p-6 bg-gray-900 border-b border-gray-700">
                <h2 class="text-3xl font-bold text-purple-400" id="gallery-title">Thư Viện</h2>
                <button onclick="hideGallery()" class="text-gray-400 hover:text-white transition"><i class="fas fa-times text-3xl"></i></button>
            </div>
            <div class="flex bg-gray-900 p-2 gap-2">
                <div class="gallery-tab active px-6 py-3 rounded-lg cursor-pointer hover:bg-gray-700 font-bold" onclick="switchTab('hero')">Tướng</div>
                <div class="gallery-tab px-6 py-3 rounded-lg cursor-pointer hover:bg-gray-700 font-bold" onclick="switchTab('normal')">Quái Thường</div>
                <div class="gallery-tab px-6 py-3 rounded-lg cursor-pointer hover:bg-gray-700 font-bold" onclick="switchTab('elite')">Tinh Anh</div>
                <div class="gallery-tab px-6 py-3 rounded-lg cursor-pointer hover:bg-gray-700 font-bold" onclick="switchTab('boss')">Boss</div>
            </div>
            <div class="flex-1 p-6 overflow-y-auto grid grid-cols-4 gap-6 content-start" id="gallery-grid">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <!-- Gacha Screen -->
    <div id="gacha-screen" class="screen-overlay hidden">
        <h2 class="text-5xl font-bold text-teal-400 mb-8 drop-shadow-md">Triệu Hồi Tướng</h2>
        <div class="relative mb-10">
            <div class="gacha-pointer"></div>
            <div class="gacha-wheel-container" id="wheel-element">
                <div class="gacha-wheel-bg"></div>
                <div class="gacha-center"><i class="fas fa-star text-3xl"></i></div>
            </div>
        </div>
        <p class="text-2xl text-white font-bold mb-2 h-8" id="gacha-result-text">?</p>
        <!-- Added Silver Display Here -->
        <p id="gacha-silver-display" class="text-xl text-yellow-400 font-bold mb-4">Bạc: 0</p>
        <p class="text-gray-400 mb-8 text-lg">Phí: 10 Bạc / lần quay</p>
        <div class="flex gap-6">
            <button id="btn-spin" onclick="spinGacha()" class="px-10 py-4 bg-teal-600 hover:bg-teal-500 rounded-xl font-bold text-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                Quay x1 (10 Bạc)
            </button>
             <button onclick="hideGacha()" class="px-8 py-4 bg-gray-600 hover:bg-gray-500 rounded-xl font-bold text-xl shadow-lg">
                Quay lại
            </button>
        </div>
    </div>

    <!-- UI: Skills Bottom Left (Moved and Compacted) -->
    <div id="skills-ui" class="absolute bottom-6 left-6 pointer-events-auto hidden flex gap-4 items-end transition-opacity duration-300 z-20">
        
        <!-- Skill 1: Summon Soldier (Unified Style) -->
        <div class="flex flex-col items-center group relative">
            <button id="btn-summon" class="skill-btn bg-green-700 border-green-500 hover:bg-green-600">
                <i class="fas fa-user-shield"></i>
                <div id="summon-overlay" class="skill-cooldown"></div>
                <div class="skill-cost" id="summon-cost-display">10G</div>
            </button>
            <div id="soldier-count-display" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-red-400 shadow">0/20</div>
        </div>

        <!-- Skill 2: Barricade -->
        <div class="flex flex-col items-center group">
            <button id="btn-barricade" onclick="activateBarricade()" class="skill-btn bg-yellow-700 border-yellow-500 hover:bg-yellow-600">
                <i class="fas fa-road-spikes"></i>
                <div id="barricade-overlay" class="skill-cooldown">10</div>
                <div class="skill-cost">20G</div>
            </button>
        </div>

        <!-- Skill 3: Frenzy -->
        <div class="flex flex-col items-center group">
            <button id="btn-frenzy" onclick="activateFrenzy()" class="skill-btn bg-red-700 border-red-500 hover:bg-red-600">
                <i class="fas fa-bolt"></i>
                <div id="frenzy-overlay-timer" class="skill-cooldown">30</div>
                <div class="skill-cost">30G</div>
            </button>
        </div>

    </div>

    <!-- UI: Info Panel -->
    <div id="info-panel-container" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 pointer-events-auto hidden transition-all duration-300 ease-out translate-y-20 opacity-0 z-20">
        <div class="bg-gray-900/95 border border-gray-500 rounded-2xl p-6 shadow-2xl flex items-center gap-6 min-w-[400px]">
            <div class="w-20 h-20 rounded-xl bg-gray-800 flex items-center justify-center text-3xl shrink-0 border-2 border-gray-600 overflow-hidden shadow-inner" id="sel-icon"></div>
            <div class="flex flex-col justify-center flex-1">
                <h3 id="sel-name" class="font-bold text-2xl text-blue-300 leading-tight">Name</h3>
                <div class="text-sm text-gray-300 mt-2 grid grid-cols-2 gap-x-6 gap-y-1">
                    <span id="sel-info-1" class="font-mono">Info 1</span>
                    <span id="sel-info-2" class="font-mono">Info 2</span>
                    <span id="sel-info-3" class="col-span-2 text-yellow-300 text-xs italic mt-1">Info 3</span>
                </div>
                <div id="hero-xp-container" class="hidden w-full bg-gray-700 h-2 mt-3 rounded-full overflow-hidden shadow-inner">
                    <div id="hero-xp-bar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
                </div>
                <p id="hero-xp-text" class="hidden text-[10px] text-blue-200 mt-1 text-right font-mono">XP: 0/10</p>
            </div>
            <button id="btn-upgrade" class="px-6 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-xl font-bold text-base shadow-lg transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed border-b-4 border-yellow-800 shrink-0">
                Nâng cấp
            </button>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="absolute inset-0 bg-black/95 flex flex-col items-center justify-center hidden z-50">
        <h1 class="text-8xl font-bold text-red-600 mb-6 drop-shadow-[0_0_15px_rgba(220,38,38,0.8)]">THẤT BẠI</h1>
        <p class="text-3xl mb-8">Bạn đã dừng bước tại Wave <span id="final-wave" class="text-white font-bold text-4xl">0</span></p>
        <p class="text-lg text-gray-400 mb-10"><i class="fas fa-save mr-2"></i>Bạc đã được lưu vào kho.</p>
        <div class="flex gap-8">
    <script>
/**
 * CONFIG & DATA
 * LƯU Ý KHI HOST VERCEL: 
 * Các link ảnh dưới đây (cdn.discordapp.com) có thể sẽ hết hạn sau một thời gian.
 * Để game hoạt động ổn định lâu dài trên Vercel, bạn nên:
 * 1. Tải các ảnh này về.
 * 2. Tạo thư mục tên 'assets' hoặc 'images' cùng cấp với file index.html.
 * 3. Đổi đường dẫn bên dưới thành đường dẫn tương đối (ví dụ: './assets/hero.png').
 */
const CONFIG = {
    FPS: 60,
    WALL_X: 300, 
    LANE_Y_START: 200, 
    LANE_HEIGHT: 800, 
    WEAPON_RANGE: 540, 
    HERO_RANGE: 518,    
    
    COLORS: {
        wall: '#4a5568', wallHighlight: '#5e6c84',
        hero: '#3b82f6', soldier: '#48bb78', soldierHighlight: '#68d391', barricade: '#d69e2e',
        enemy: '#f56565', enemyHighlight: '#fc8181', elite: '#ed8936', boss: '#805ad5',
        projectile: '#f6e05e', text: '#ffffff'
    },
    IMAGES: {
        hero: 'https://cdn.discordapp.com/attachments/1080729795836526632/1446457287857147904/85986840_pixian_ai.png?ex=69340dd3&is=6932bc53&hm=095c6646ef7679010d39b4c217e374cda7e30983db89f096a911450a8126f631&',
        normal: 'https://cdn.discordapp.com/attachments/1080729795836526632/1446457289669218314/85986835_pixian_ai.png?ex=69340dd3&is=6932bc53&hm=71a6c853f7683f7201e94ab4793f4bc9af3864651d4656b1bdddd41ca5442479&',
        elite: 'https://cdn.discordapp.com/attachments/1080729795836526632/1446457287320404018/85986836_pixian_ai.png?ex=69340dd3&is=6932bc53&hm=d6151df439d1acf979440c32abbf988733fbda3afc0ec23fe96d6bccabc0c454&',
        boss: 'https://cdn.discordapp.com/attachments/1080729795836526632/1446457288620769351/85986833_pixian_ai.png?ex=69340dd3&is=6932bc53&hm=4afb47da2760dc208a1197d4fed3c117eb30bbe08e7e8eadfabd89d64e955a2b&',
        soldier: 'https://cdn.discordapp.com/attachments/1080729795836526632/1446463449486983218/85986830_pixian_ai.png?ex=69341390&is=6932c210&hm=f6c9dc3e313a2ffd6dc8fd4fc398cfca422bdc7336f974c5a5a6b8920e86e6ce&',
        bg1: 'https://cdn.discordapp.com/attachments/1080729795836526632/1446469980546797681/2c707c40542db4f0770c28478d92d7f4.png?ex=693419a5&is=6932c825&hm=08309250d70dfc2fc16b1ea96af56b50bf2755ef7beb914e71455b6c9fba0b0c&',
        bg2: 'https://cdn.discordapp.com/attachments/1080729795836526632/1446470013472215040/dec465cd4786fb487242518168040e47.png?ex=693419ad&is=6932c82d&hm=84cafb3f85c0e57de11bc11dae959c059365364bf726ee2f8d99a2cdd7aab300&'
    }
};

const HERO_DB = [
    { id: 0, name: "Xạ Thủ Tập Sự", skill1: "Triệu Hồi Lính", skill2: "Chí Mạng x2", desc: "Tướng khởi đầu cơ bản.", color: "#3b82f6", img: CONFIG.IMAGES.hero },
    { id: 1, name: "Cung Thủ Tinh Linh", skill1: "Bắn Nhanh", skill2: "Đẩy Lùi", desc: "Tốc độ bắn cực nhanh.", color: "#48bb78", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507473920856178/85986839_1_pixian_ai.png?ex=69343c90&is=6932eb10&hm=84e9425e1065b8541d173378f4a57f3f1725834f74072902ea163370f7a85492&" },
    { id: 2, name: "Pháp Sư Lửa", skill1: "Cầu Lửa AoE", skill2: "Thiêu Đốt", desc: "Gây sát thương diện rộng.", color: "#f56565", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507474269245492/111729985_1_pixian_ai.png?ex=69343c90&is=6932eb10&hm=61267762bd1f0ccc94c68aa3cdbc16c4d1f4aabc8cfde015d7f2bda9cbe5e28b&" },
    { id: 3, name: "Thợ Săn Bóng Đêm", skill1: "Chí Mạng x3", skill2: "Tàng Hình", desc: "Sát thủ đơn mục tiêu.", color: "#2d3748", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507471970631702/85986831_pixian_ai.png?ex=69343c90&is=6932eb10&hm=0cbb822f288f62dd4223394328c8289296ac73793d6e763d2155dd007c217f2e&" },
    { id: 4, name: "Kỹ Sư Máy Móc", skill1: "Sửa Tường", skill2: "Đặt Mìn", desc: "Hỗ trợ phòng thủ.", color: "#ecc94b", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507473493295360/85986838_pixian_ai.png?ex=69343c90&is=6932eb10&hm=325fc530289e1c23dada0b1e726ac6a82bca6830cabe6b27a546e12c89e536d2&" },
    { id: 5, name: "Chiến Binh Thép", skill1: "Choáng", skill2: "Giáp Phản", desc: "Làm chậm kẻ địch.", color: "#a0aec0", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507472448917616/85986834_pixian_ai.png?ex=69343c90&is=6932eb10&hm=1bcdff8d96fb87da6998acbea95411ae9a8305afb073f80381438e960a17ae8a&" },
    { id: 6, name: "Kẻ Trộm Vàng", skill1: "Cướp Vàng", skill2: "Né Tránh", desc: "Tăng thu nhập vàng.", color: "#ed8936", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507470871855148/85986828_pixian_ai.png?ex=69343c8f&is=6932eb0f&hm=02103a1b89d8518fb491385bc657ea284af008610372fbb61851e11155b858f3&" },
    { id: 7, name: "Băng Giá Vĩnh Cửu", skill1: "Làm Chậm", skill2: "Đóng Băng", desc: "Khống chế diện rộng.", color: "#63b3ed", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507471488155742/85986829_pixian_ai.png?ex=69343c90&is=6932eb10&hm=2dee651961fe94204ea2a93fa8207573bed53dd65accb7620313e58524e94e74&" },
    { id: 8, name: "Triệu Hồi Sư", skill1: "Lính x2", skill2: "Hồi Máu Lính", desc: "Chuyên gia gọi đệ.", color: "#9f7aea", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507469902843935/85986826_pixian_ai.png?ex=69343c8f&is=6932eb0f&hm=fe6684b8426927e3b4cefa6dc2c50ec5d554aa6b913f9f39a4d768c7f2df780d&" },
    { id: 9, name: "Thiện Xạ Thần", skill1: "Xuyên Thấu", skill2: "Tầm Xa +50%", desc: "Bắn xuyên nhiều mục tiêu.", color: "#ed64a6", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507472977264650/85986837_pixian_ai.png?ex=69343c90&is=6932eb10&hm=852fd57c6f3aeb59d540b9005cf031700f347d77d769191553a05b6ce68fa5c9&" },
    { id: 10, name: "Vua Hải Tặc", skill1: "Pháo Hạm", skill2: "Tiền Thưởng", desc: "Sức mạnh hủy diệt.", color: "#e53e3e", img: "https://cdn.discordapp.com/attachments/1080729795836526632/1446507470343241738/85986827_pixian_ai.png?ex=69343c8f&is=6932eb0f&hm=d5570aa749870d8c1e3f0816a772e0547394f69cdd2659ce977563e18e8f88f4&" }
];

const ENEMY_DB = {
    'normal': { name: "Quái Thường", img: CONFIG.IMAGES.normal, hp: "30 (+5%)", dmg: "5 (+3%)", spd: "1.0", desc: "Kẻ địch cơ bản." },
    'elite': { name: "Quái Tinh Anh", img: CONFIG.IMAGES.elite, hp: "45 (+5%)", dmg: "7 (+3%)", spd: "0.8", desc: "Mạnh hơn quái thường." },
    'elite_special': { name: "TA Đặc Biệt", img: CONFIG.IMAGES.elite, hp: "100 (+10%)", dmg: "12 (+5%)", spd: "0.85", desc: "Sở hữu hiệu ứng ngẫu nhiên." },
    'boss': { name: "Đại Chúa Tể", img: CONFIG.IMAGES.boss, hp: "800 (+5%)", dmg: "20 (+3%)", spd: "0.4", desc: "Boss mỗi 5 wave." },
    'ranged': { name: "Quái Xạ Thủ", img: CONFIG.IMAGES.normal, hp: "20 (+5%)", dmg: "4 (+3%)", spd: "0.9", desc: "Tấn công từ xa." },
    'elite_tank': { name: "Cự Nhân Hộ Vệ", img: CONFIG.IMAGES.elite, hp: "68 (+5%)", dmg: "7 (+3%)", spd: "0.7", desc: "Máu trâu x1.5" },
    'elite_speed': { name: "Ảnh Sát Thủ", img: CONFIG.IMAGES.elite, hp: "45 (+5%)", dmg: "7 (+3%)", spd: "1.2", desc: "Tốc độ x1.5" }
};

const ELITE_EFFECTS = [
    { id: 'STEAL', name: "Cướp Vàng", color: "#FFD700" },
    { id: 'WALL_BREAKER', name: "Phá Tường", color: "#FF0000" },
    { id: 'TANKY', name: "Giáp Cứng", color: "#808080" },
    { id: 'REGEN', name: "Hồi Máu", color: "#00FF00" },
    { id: 'EXPLODE', name: "Phát Nổ", color: "#FFA500" },
    { id: 'DODGE', name: "Né Tránh", color: "#87CEEB" },
    { id: 'SLOW_AURA', name: "Băng Giá", color: "#00FFFF" },
    { id: 'BERSERK', name: "Cuồng Nộ", color: "#8B0000" },
    { id: 'WEAKEN', name: "Suy Yếu", color: "#800080" },
    { id: 'VAMP', name: "Hút Máu", color: "#FF1493" }
];

const imgAssets = {};
for (const [key, url] of Object.entries(CONFIG.IMAGES)) {
    const img = new Image(); img.src = url; imgAssets[key] = img;
}
HERO_DB.forEach(h => {
    const img = new Image(); img.src = h.img; imgAssets['hero'+h.id] = img;
});

/**
 * GAME STATE
 */
const state = {
    gameStarted: false,
    gameOver: false,
    paused: false,
    width: 1920, height: 1080, ctx: null, lastTime: 0,
    timeScale: 1, 
    
    wallHp: 1000, maxWallHp: 1000, gold: 100,
    silver: parseInt(localStorage.getItem('iw_silver')) || 0,
    unlockedHeroes: JSON.parse(localStorage.getItem('iw_heroes')) || [0],
    currentHeroId: 0,
    
    wallObj: { type: 'wall', lvl: 1, upgradeCost: 100 },
    
    waveNumber: 1, isIntermission: true, intermissionTimer: 30, intermissionInterval: null,
    globalDifficultyMultiplier: 1.0, enemiesToSpawn: 0, elitesToSpawn: 0, spawnTimer: 0, bossSpawnedInWave: false,
    
    weapons: [],
    hero: { 
        lvl: 1, dmg: 10, fireRate: 60, cooldown: 0, 
        range: CONFIG.HERO_RANGE, 
        x: 50, y: 50, speed: 3, 
        color: CONFIG.COLORS.hero, type: 'hero', xp: 0, reqXp: 10,
        attackCount: 0, nextAttackCrit: false, rangeBuffTimer: 0, animTimer: 0
    },
    soldiers: [], enemies: [], projectiles: [], particles: [], 
    selectedEntity: null, 
    
    // Skills
    summonCooldownMax: 600, summonCooldown: 0, summonCost: 10,
    barricadeCooldown: 0, barricadeCooldownMax: 600,
    frenzyCooldown: 0, frenzyCooldownMax: 1800, frenzyActiveTimer: 0,

    bgIndex: 0
};

// Init Weapons
for (let i = 0; i < 5; i++) {
    state.weapons.push({ id: i, lvl: 0, baseDmg: 5, dmg: 0, baseFireRate: 90, fireRate: 90, range: CONFIG.WEAPON_RANGE, cooldown: 0, x: 40, y: 300 + i * 120, width: 60, height: 60, upgradeCost: 30, bought: false, type: 'weapon', animTimer: 0 });
}

function initGame() {
    const canvas = document.getElementById('gameCanvas');
    state.ctx = canvas.getContext('2d');
    
    window.addEventListener('resize', handleResize);
    handleResize();
    
    canvas.addEventListener('mousedown', handleInput);
    canvas.addEventListener('touchstart', (e) => handleInput(e.touches[0]), {passive: false});
    
    document.getElementById('btn-summon').onclick = summonSoldier;
    document.getElementById('btn-skip').onclick = startWave;
    document.getElementById('btn-pause').onclick = togglePause;
    
    buildGachaWheel();
    updateUI();
    state.lastTime = performance.now();
    
    requestAnimationFrame(gameLoop); 
}

function handleResize() {
    const wrapper = document.getElementById('game-wrapper');
    const startY = 1080 / 2 - (5 * 120) / 2;
    state.hero.y = 1080 / 2;
    state.hero.x = CONFIG.WALL_X / 2;
    state.weapons.forEach((w, i) => { w.x = 60; w.y = startY + i * 120; });
}

function showSilverInfo() {
    spawnFloatingText("Diệt Boss/Quái cuối Wave để kiếm Bạc!", state.width/2, 100, '#fff', 30);
}

function buildGachaWheel() {
    const container = document.getElementById('wheel-element');
    container.innerHTML = '<div class="gacha-wheel-bg"></div><div class="gacha-center z-10"><i class="fas fa-star text-3xl"></i></div>';
    
    const sliceAngle = 360 / 10; 
    HERO_DB.slice(0, 10).forEach((h, index) => { 
        const content = document.createElement('div');
        content.style.position = 'absolute';
        content.style.top = '0';
        content.style.left = '50%';
        content.style.height = '50%';
        content.style.width = '0px';
        content.style.transformOrigin = 'bottom';
        content.style.transform = `translateX(-50%) rotate(${index * sliceAngle}deg)`;
        
        const inner = document.createElement('div');
        inner.style.marginTop = '20px';
        inner.innerHTML = `<img src="${h.img}" class="wheel-img">`;
        
        content.appendChild(inner);
        container.appendChild(content);
    });
}

function resetGame(toLobby) {
    state.gameOver = false;
    state.paused = false;
    state.timeScale = 1; 
    state.wallHp = 1000;
    state.maxWallHp = 1000;
    state.gold = 100;
    state.waveNumber = 1;
    state.globalDifficultyMultiplier = 1.0;
    state.soldiers = [];
    state.enemies = [];
    state.projectiles = [];
    state.particles = [];
    state.selectedEntity = null;
    state.summonCost = 10;
    state.summonCooldown = 0;
    state.barricadeCooldown = 0;
    state.frenzyCooldown = 0;
    state.frenzyActiveTimer = 0;
    
    state.weapons.forEach(w => {
        w.lvl = 0; w.dmg = 0; w.bought = false; w.upgradeCost = 30; w.fireRate = 90; w.range = CONFIG.WEAPON_RANGE;
    });
    
    state.hero.lvl = 1; state.hero.dmg = 10; state.hero.fireRate = 60; state.hero.range = CONFIG.HERO_RANGE; state.hero.xp = 0; state.hero.reqXp = 10;
    
    const heroData = HERO_DB.find(h => h.id === state.currentHeroId);
    if(heroData) state.hero.color = heroData.color; 
    
    document.getElementById('game-over-screen').classList.add('hidden');
    document.getElementById('skills-ui').classList.add('hidden');
    document.getElementById('info-panel-container').classList.add('hidden');
    document.getElementById('btn-surrender').classList.add('hidden');
    document.getElementById('btn-pause').classList.add('hidden'); 
    document.getElementById('btn-speed').classList.add('hidden');
    document.getElementById('btn-speed').innerText = "x1";
    document.getElementById('frenzy-overlay').style.display = 'none';
    
    state.wallObj.lvl = 1;
    state.wallObj.upgradeCost = 100;

    if (toLobby) {
        state.gameStarted = false;
        document.getElementById('start-screen').classList.remove('hidden');
        document.getElementById('ingame-stats').classList.add('hidden');
        draw(); 
    } else {
        startGame();
    }
}

function startGame() {
    state.gameStarted = true;
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('skills-ui').classList.remove('hidden');
    document.getElementById('ingame-stats').classList.remove('hidden');
    document.getElementById('btn-surrender').classList.remove('hidden');
    document.getElementById('btn-pause').classList.remove('hidden'); 
    document.getElementById('btn-speed').classList.remove('hidden');
    
    startIntermission();
}

function toggleSpeed() {
    if (state.timeScale === 1) {
        state.timeScale = 2;
        document.getElementById('btn-speed').innerText = "x2";
        document.getElementById('btn-speed').classList.replace('bg-blue-700', 'bg-red-600');
    } else {
        state.timeScale = 1;
        document.getElementById('btn-speed').innerText = "x1";
        document.getElementById('btn-speed').classList.replace('bg-red-600', 'bg-blue-700');
    }
}

// --- GALLERY & GACHA ---
let currentGalleryTab = 'hero';
function showGallery() { document.getElementById('start-screen').classList.add('hidden'); document.getElementById('gallery-screen').classList.remove('hidden'); switchTab('hero'); }
function openHeroSelect() { state.paused = true; document.getElementById('gallery-screen').classList.remove('hidden'); document.getElementById('gallery-title').innerText = "Chọn Tướng"; switchTab('hero'); }
function hideGallery() { document.getElementById('gallery-screen').classList.add('hidden'); if(state.gameStarted) { state.paused = false; document.getElementById('gallery-title').innerText = "Thư Viện"; } else { document.getElementById('start-screen').classList.remove('hidden'); } }

function switchTab(tab) {
    currentGalleryTab = tab;
    const tabs = document.querySelectorAll('.gallery-tab');
    tabs.forEach(t => t.classList.remove('active'));
    if (window.event && window.event.target) window.event.target.classList.add('active');
    
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = '';
    
    if (tab === 'hero') {
        HERO_DB.forEach(h => {
            const isUnlocked = state.unlockedHeroes.includes(h.id);
            const isSelected = state.currentHeroId === h.id;
            const el = document.createElement('div');
            el.className = `card ${!isUnlocked ? 'locked' : ''} ${isSelected ? 'selected' : ''}`;
            
            let imgHTML = `<div class="w-20 h-20 rounded-full mb-2 overflow-hidden border-2 border-gray-600"><img src="${h.img}" class="w-full h-full object-cover"></div>`;
            
            el.innerHTML = `${imgHTML}<h3 class="font-bold text-blue-300 text-center text-sm">${h.name}</h3><p class="text-xs text-gray-400 text-center italic mb-2 h-10 overflow-hidden">${h.desc}</p><div class="text-xs text-left w-full bg-gray-800 p-2 rounded"><p>Skill 1: <span class="text-green-400">${h.skill1}</span></p><p>Skill 2: <span class="text-red-400">${h.skill2}</span></p></div>${!isUnlocked ? '<p class="text-red-500 font-bold mt-2 text-xs">Chưa sở hữu</p>' : ''}${isUnlocked && !isSelected ? `<button onclick="selectHero(${h.id})" class="mt-2 px-3 py-1 bg-blue-600 rounded text-xs hover:bg-blue-500 w-full">Chọn</button>` : ''}${isSelected ? '<p class="text-green-500 font-bold mt-2 text-xs">Đang chọn</p>' : ''}`;
            grid.appendChild(el);
        });
    } else {
        const keys = tab === 'normal' ? ['normal', 'ranged'] : (tab === 'elite' ? ['elite', 'elite_tank', 'elite_speed', 'elite_special'] : ['boss']); 
        keys.forEach(k => {
            if(!ENEMY_DB[k]) return;
            const d = ENEMY_DB[k];
            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `<div class="w-24 h-24 rounded-full mb-4 overflow-hidden bg-gray-900 border-2 border-gray-600"><img src="${d.img}" class="w-full h-full object-cover"></div><h3 class="font-bold text-xl text-red-400">${d.name}</h3><p class="text-xs text-gray-400 mb-2 text-center">${d.desc}</p><div class="w-full text-sm"><p class="flex justify-between border-b border-gray-700 py-1"><span>HP:</span> <span class="text-green-400">${d.hp}</span></p><p class="flex justify-between border-b border-gray-700 py-1"><span>DMG:</span> <span class="text-red-400">${d.dmg}</span></p><p class="flex justify-between border-b border-gray-700 py-1"><span>SPD:</span> <span class="text-yellow-400">${d.spd}</span></p></div>`;
            grid.appendChild(el);
        });
    }
}

function selectHero(id) { 
    state.currentHeroId = id; 
    const heroData = HERO_DB.find(h => h.id === id);
    state.hero.color = heroData.color; 
    switchTab('hero'); 
}

function showGacha() { 
    document.getElementById('start-screen').classList.add('hidden'); 
    document.getElementById('gacha-screen').classList.remove('hidden'); 
    document.getElementById('gacha-result-text').innerText = "?";
    document.getElementById('gacha-silver-display').innerText = `Bạc hiện có: ${state.silver}`;
}
function hideGacha() { document.getElementById('gacha-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); }
function spinGacha() {
    if (state.silver < 10) { spawnFloatingText("Không đủ Bạc! (Cần 10)", state.width/2, 200, 'red', 30); return; }
    state.silver -= 10; addSilver(0);
    document.getElementById('gacha-silver-display').innerText = `Bạc hiện có: ${state.silver}`;
    
    const wheel = document.getElementById('wheel-element');
    const resultText = document.getElementById('gacha-result-text');
    const btn = document.getElementById('btn-spin');
    btn.disabled = true; resultText.innerText = "Đang quay...";
    const wonId = Math.floor(Math.random() * 10) + 1; // 1-10
    const sliceAngle = 360/10;
    const targetIndex = wonId - 1; 
    const randomOffset = Math.random() * 20 - 10; 
    const angle = 360 * 5 - (targetIndex * sliceAngle) + randomOffset; 
    
    wheel.style.transform = `rotate(${angle}deg)`;
    
    setTimeout(() => {
        const hero = HERO_DB.find(h => h.id === wonId);
        if (!state.unlockedHeroes.includes(wonId)) {
            state.unlockedHeroes.push(wonId); localStorage.setItem('iw_heroes', JSON.stringify(state.unlockedHeroes));
            resultText.innerText = `Chúc mừng! Bạn nhận được: ${hero.name}`; resultText.className = "text-green-400 font-bold mb-2 text-2xl animate-bounce";
        } else {
            state.silver += 5; addSilver(0);
            resultText.innerText = `Đã có ${hero.name}! Nhận lại 5 Bạc.`; resultText.className = "text-yellow-400 font-bold mb-2 text-xl";
            document.getElementById('gacha-silver-display').innerText = `Bạc hiện có: ${state.silver}`;
        }
        btn.disabled = false; wheel.style.transition = 'none'; wheel.style.transform = 'rotate(0deg)'; setTimeout(() => wheel.style.transition = 'transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)', 50);
    }, 4000);
}

// --- GAME LOGIC ---

function forceGameOver() { state.wallHp = 0; gameOver(); }

function startIntermission() {
    state.isIntermission = true; state.intermissionTimer = 30;
    document.getElementById('ui-timer').classList.remove('hidden'); document.getElementById('btn-skip').classList.remove('hidden');
    if ((state.waveNumber - 1) % 5 === 0 && state.waveNumber > 1) state.bgIndex = Math.random() < 0.5 ? 0 : 1;
    updateUI();
    if (state.intermissionInterval) clearInterval(state.intermissionInterval);
    state.intermissionInterval = setInterval(() => {
        if (state.paused) return;
        state.intermissionTimer--; document.getElementById('ui-timer').innerText = `Tiếp theo: ${state.intermissionTimer}s`;
        if (state.intermissionTimer <= 0) startWave();
    }, 1000);
}

function startWave() {
    clearInterval(state.intermissionInterval); state.isIntermission = false;
    document.getElementById('ui-timer').classList.add('hidden'); document.getElementById('btn-skip').classList.add('hidden'); 
    
    // Feature 1: Monster Count Logic
    // Wave 1-5: Base + 1 per wave
    // Wave 5+: +5-10% increase
    let baseCount = 3 + Math.floor(Math.random() * 3);
    let count = 0;
    
    if (state.waveNumber <= 5) {
        count = baseCount + state.waveNumber;
    } else {
        // Simple scaling: (base + 5) * 1.1^(wave-5) to simulate ~10% compound growth
        let prevBase = baseCount + 5;
        let growthFactor = Math.pow(1.08, state.waveNumber - 5);
        count = Math.floor(prevBase * growthFactor);
    }

    state.enemiesToSpawn = count;
    
    if (state.waveNumber > 1 && state.waveNumber % 2 !== 0) state.elitesToSpawn = Math.floor(Math.random() * 3) + 1; else state.elitesToSpawn = 0;
    state.bossSpawnedInWave = false;
}

function spawnEnemyLogic() {
    if (state.isIntermission) return;
    state.spawnTimer--;
    const canSpawnNormal = state.enemiesToSpawn > 0;
    const canSpawnElite = state.elitesToSpawn > 0;

    if (state.spawnTimer <= 0 && (canSpawnNormal || canSpawnElite)) {
        state.spawnTimer = Math.random() * 60 + 60; 
        const isRanged = Math.random() < 0.2; 
        if (canSpawnElite && canSpawnNormal) {
            if (Math.random() < 0.3) { spawnOneEnemy('elite_random'); state.elitesToSpawn--; } 
            else { spawnOneEnemy(isRanged ? 'ranged' : 'normal'); state.enemiesToSpawn--; }
        } else if (canSpawnElite) { spawnOneEnemy('elite_random'); state.elitesToSpawn--; } 
        else { spawnOneEnemy(isRanged ? 'ranged' : 'normal'); state.enemiesToSpawn--; }
    } 
    else if (state.spawnTimer <= 0 && !canSpawnNormal && !canSpawnElite && state.waveNumber % 5 === 0 && !state.bossSpawnedInWave) {
        state.bossSpawnedInWave = true; spawnOneEnemy('boss');
    }
}

function spawnOneEnemy(type) {
    if (type === 'elite_random') {
        const r = Math.random();
        if(r < 0.25) type = 'elite';
        else if(r < 0.50) type = 'elite_tank';
        else if(r < 0.75) type = 'elite_speed';
        else type = 'elite_special'; // Feature 2: Added special elite chance
    }

    let baseHp = 30; let baseDmg = 5; let baseSpeed = 1.0; let radius = 50; 
    let isBoss = false; let isElite = false; let isRanged = false;
    let specialEffect = null;

    if (type === 'boss') { baseHp = 800; baseDmg = 20; baseSpeed = 0.4; radius = 100; isBoss = true; }
    else if (type === 'elite') { baseHp = 45; baseDmg = 7; baseSpeed = 0.8; radius = 70; isElite = true; }
    else if (type === 'elite_tank') { baseHp = 68; baseDmg = 7; baseSpeed = 0.7; radius = 75; isElite = true; }
    else if (type === 'elite_speed') { baseHp = 45; baseDmg = 7; baseSpeed = 1.2; radius = 60; isElite = true; }
    else if (type === 'elite_special') { 
        baseHp = 100; baseDmg = 12; baseSpeed = 0.85; radius = 70; isElite = true;
        // Feature 2: Pick Random Effect
        specialEffect = ELITE_EFFECTS[Math.floor(Math.random() * ELITE_EFFECTS.length)];
    }
    else if (type === 'ranged') { baseHp = 20; baseDmg = 4; baseSpeed = 0.9; radius = 40; isRanged = true; }

    const hp = Math.round(baseHp * (1 + 0.05 * state.waveNumber) * state.globalDifficultyMultiplier);
    const dmg = Math.round(baseDmg * (1 + 0.03 * state.waveNumber) * state.globalDifficultyMultiplier);
    const startY = (state.height / 2 - 200) + Math.random() * 400; 

    const enemy = {
        id: Math.random(), type: type, x: state.width + 100, y: startY,
        radius: radius, hp: hp, maxHp: hp, dmg: dmg, speed: baseSpeed,
        isBoss: isBoss, isElite: isElite, isRanged: isRanged, specialEffect: specialEffect,
        attackCooldown: 0, animTimer: 0, wallPrepareTimer: 0, slowTimer: 0
    };
    state.enemies.push(enemy);
}

function endWave() {
    state.waveNumber++;
    if ((state.waveNumber - 1) % 5 === 0) { state.globalDifficultyMultiplier *= 1.1; spawnFloatingText("ĐỘ KHÓ TĂNG!", state.width/2, state.height/2, "red", 40); }
    updateUI(); startIntermission();
}

function gameLoop(timestamp) {
    if (state.gameOver) return;
    const dt = timestamp - state.lastTime;
    if (state.gameStarted && !state.paused) {
        for(let i=0; i<state.timeScale; i++) update(dt);
    }
    if (state.gameStarted) draw();
    else if (!state.gameStarted && !document.getElementById('start-screen').classList.contains('hidden')) {
         const ctx = state.ctx; ctx.clearRect(0, 0, state.width, state.height);
         ctx.fillStyle = '#1a202c'; ctx.fillRect(0,0,state.width, state.height);
         draw(); 
    }

    state.lastTime = timestamp;
    requestAnimationFrame(gameLoop);
}

function update(dt) {
    if (state.summonCooldown > 0) state.summonCooldown--;
    if (state.barricadeCooldown > 0) state.barricadeCooldown--;
    if (state.frenzyCooldown > 0) state.frenzyCooldown--;
    if (state.frenzyActiveTimer > 0) state.frenzyActiveTimer--;
    
    // Toggle Frenzy Overlay
    if(state.frenzyActiveTimer > 0) document.getElementById('frenzy-overlay').style.display = 'block';
    else document.getElementById('frenzy-overlay').style.display = 'none';

    if (state.hero.rangeBuffTimer > 0) state.hero.rangeBuffTimer--;
    if(state.hero.animTimer > 0) state.hero.animTimer--;
    state.weapons.forEach(w => { if(w.animTimer > 0) w.animTimer--; });
    state.enemies.forEach(e => { if(e.animTimer > 0) e.animTimer--; if(e.slowTimer > 0) e.slowTimer--; });

    spawnEnemyLogic();

    const canSpawnNormal = state.enemiesToSpawn > 0;
    const canSpawnElite = state.elitesToSpawn > 0;
    const allSpawned = !canSpawnNormal && !canSpawnElite && (state.waveNumber % 5 !== 0 || state.bossSpawnedInWave);
    if (allSpawned && state.enemies.length === 0 && !state.isIntermission) endWave();

    // --- HERO AI ---
    let closestEnemyToHero = null;
    let minDistHero = Infinity;
    for (let e of state.enemies) {
        if (e.x < CONFIG.WALL_X + 600) { 
             const dist = Math.hypot(state.hero.x - e.x, state.hero.y - e.y);
             if (dist < minDistHero) { minDistHero = dist; closestEnemyToHero = e; }
        }
    }
    if (closestEnemyToHero) {
        if (state.hero.y < closestEnemyToHero.y - 10) state.hero.y += state.hero.speed;
        else if (state.hero.y > closestEnemyToHero.y + 10) state.hero.y -= state.hero.speed;
        state.hero.y = Math.max(100, Math.min(state.height - 100, state.hero.y));
    }
    
    // --- SOLDIER & BARRICADE AI ---
    const SOLDIER_MAX_X = CONFIG.WALL_X + CONFIG.WEAPON_RANGE;
    const enemyTargetCounts = {}; state.enemies.forEach(e => enemyTargetCounts[e.id] = 0);
    
    state.soldiers.forEach(s => {
        if(s.type === 'barricade') return; // Barricades don't move or attack

        let bestTarget = null; let bestScore = Infinity; 
        state.enemies.forEach(e => {
            const dist = Math.hypot(s.x - e.x, s.y - e.y);
            if(e.x <= SOLDIER_MAX_X || dist < 200) {
                const currentTargetCount = enemyTargetCounts[e.id] || 0;
                const score = dist + (currentTargetCount * 1000); 
                if (score < bestScore) { bestScore = score; bestTarget = e; }
            }
        });

        if (bestTarget) {
            enemyTargetCounts[bestTarget.id]++;
            s.facingLeft = (bestTarget.x < s.x);
            const dx = bestTarget.x - s.x;
            const dy = bestTarget.y - s.y;
            const dist = Math.hypot(dx, dy);
            
            if (dist < s.radius + bestTarget.radius + 10) {
                if (s.attackCooldown <= 0) { 
                    bestTarget.hp -= s.dmg; s.attackCooldown = 60; 
                    spawnEffect(s.x + (bestTarget.x-s.x)/2, s.y + (bestTarget.y-s.y)/2, s.dmg); 
                    
                    // Frenzy Effect
                    if(state.frenzyActiveTimer > 0) s.attackCooldown = 30; // Double speed
                }
            } else {
                let nextX = s.x + Math.cos(Math.atan2(dy, dx)) * s.speed;
                if (nextX > SOLDIER_MAX_X && bestTarget.x > SOLDIER_MAX_X) { if (s.x < SOLDIER_MAX_X) s.x = SOLDIER_MAX_X; } 
                else { s.x = nextX; s.y += Math.sin(Math.atan2(dy, dx)) * s.speed; }
            }
        } else {
            s.facingLeft = false; 
            const guardX = CONFIG.WALL_X + 50; 
            const dx = guardX - s.x;
            if (Math.abs(dx) > 5) s.x += Math.sign(dx) * s.speed;
        }
        if (s.attackCooldown > 0) s.attackCooldown--;
    });

    // --- ENEMY AI & SPECIAL EFFECTS ---
    state.enemies.forEach(e => {
        let currentSpeed = e.speed;
        if (e.slowTimer > 0) currentSpeed *= 0.5;

        // Special Effect: Regen
        if(e.specialEffect && e.specialEffect.id === 'REGEN' && Math.random() < 0.01) {
            e.hp = Math.min(e.maxHp, e.hp + e.maxHp*0.05);
            spawnFloatingText("+HP", e.x, e.y, "#00FF00", 14);
        }

        let blocked = false;
        for (let s of state.soldiers) {
            const dist = Math.hypot(e.x - s.x, e.y - s.y);
            if (dist < e.radius + s.radius + 10) {
                blocked = true;
                if (e.attackCooldown <= 0) { 
                    // Special Effect: Weaken Soldier
                    if(e.specialEffect && e.specialEffect.id === 'WEAKEN') {
                        s.dmg = Math.max(1, Math.floor(s.dmg * 0.8));
                    }
                    
                    let dmg = e.dmg;
                    // Special Effect: Berserk
                    if(e.specialEffect && e.specialEffect.id === 'BERSERK' && e.hp < e.maxHp * 0.3) {
                        dmg *= 2; spawnFloatingText("CRIT!", e.x, e.y, "red", 16);
                    }

                    s.hp -= dmg; e.attackCooldown = 60; e.animTimer = 10; spawnEffect(s.x, s.y, dmg); 
                    
                    // Special Effect: Vampiric
                    if(e.specialEffect && e.specialEffect.id === 'VAMP') {
                        e.hp = Math.min(e.maxHp, e.hp + dmg);
                    }
                    // Special Effect: Steal Gold
                    if(e.specialEffect && e.specialEffect.id === 'STEAL') {
                        if(state.gold > 0) { state.gold = Math.max(0, state.gold - 2); updateUI(); spawnFloatingText("-2G", e.x, e.y, "yellow", 16); }
                    }
                }
                break; 
            }
        }
        
        if (!blocked && e.isRanged) {
            if (e.x <= CONFIG.WALL_X + 300) { 
                blocked = true;
                if (e.attackCooldown <= 0) {
                    state.projectiles.push({ x: e.x, y: e.y, targetId: 'wall', speed: 5, dmg: e.dmg, color: '#f56565' });
                    e.attackCooldown = 90; e.animTimer = 10;
                }
            }
        }
        else if (!blocked && e.x - e.radius <= CONFIG.WALL_X) {
            blocked = true;
            if (e.wallPrepareTimer === 0) e.wallPrepareTimer = 30; 
            if (e.wallPrepareTimer > 0) e.wallPrepareTimer--;
            else if (e.attackCooldown <= 0) { 
                let dmg = e.dmg;
                if(e.specialEffect && e.specialEffect.id === 'WALL_BREAKER') dmg *= 3;
                if(e.specialEffect && e.specialEffect.id === 'STEAL' && state.gold > 0) {
                     state.gold = Math.max(0, state.gold - 5); updateUI(); spawnFloatingText("-5G", e.x, e.y, "yellow", 16); 
                }

                takeWallDamage(dmg); e.attackCooldown = 60; e.animTimer = 10; spawnEffect(CONFIG.WALL_X, e.y, 'BANG'); 
                
                if(e.specialEffect && e.specialEffect.id === 'EXPLODE') {
                    e.hp = 0; // Suicide bomber
                    takeWallDamage(dmg * 2); spawnEffect(CONFIG.WALL_X, e.y, 'BOOM');
                }
            }
        } else { e.wallPrepareTimer = 0; }

        if (!blocked) e.x -= currentSpeed;
        if (e.attackCooldown > 0) e.attackCooldown--;
    });

    // --- TOWERS & HERO ---
    [state.hero, ...state.weapons].forEach(unit => {
        if (!unit.bought && unit.type !== 'hero') return;
        
        // Frenzy: Reduce cooldown faster
        let cooldownReduction = 1;
        if(state.frenzyActiveTimer > 0) cooldownReduction = 2;
        
        if (unit.cooldown > 0) { unit.cooldown -= cooldownReduction; return; }

        let target = null; let minStore = Infinity;
        let effectiveRange = unit.range;
        if (unit.type === 'hero' && state.hero.rangeBuffTimer > 0) effectiveRange *= 1.2;

        for (let e of state.enemies) {
            const dist = Math.hypot(unit.x - e.x, unit.y - e.y);
            if (dist <= effectiveRange && dist < minStore) { minStore = dist; target = e; }
        }

        if (target) {
            unit.animTimer = 5;
            let finalDmg = unit.dmg;
            if (unit.type === 'hero') {
                state.hero.attackCount++;
                if (state.hero.attackCount >= 10) { state.hero.attackCount = 0; triggerHeroSkills(); }
                if (state.hero.nextAttackCrit) { finalDmg *= 2; state.hero.nextAttackCrit = false; }
            }
            state.projectiles.push({ x: unit.x, y: unit.y, targetId: target.id, speed: 15, dmg: finalDmg, color: unit.type === 'hero' ? '#63b3ed' : '#f6e05e' });
            unit.cooldown = unit.fireRate;
        }
    });

    for (let i = state.projectiles.length - 1; i >= 0; i--) {
        const p = state.projectiles[i];
        if (p.targetId === 'wall') {
            p.x -= p.speed;
            if (p.x <= CONFIG.WALL_X) { takeWallDamage(p.dmg); spawnEffect(CONFIG.WALL_X, p.y, 'BANG'); state.projectiles.splice(i, 1); }
            continue;
        }
        const target = state.enemies.find(e => e.id === p.targetId);
        if (!target) { state.projectiles.splice(i, 1); continue; }
        const dx = target.x - p.x; const dy = target.y - p.y;
        const dist = Math.hypot(dx, dy);
        
        // Projectile Hit
        if (dist < p.speed + target.radius) { 
            // Special Effect: Dodge
            if(target.specialEffect && target.specialEffect.id === 'DODGE' && Math.random() < 0.5) {
                spawnFloatingText("MISS", target.x, target.y, "white", 14);
            } else {
                let dmg = p.dmg;
                // Special Effect: Tanky
                if(target.specialEffect && target.specialEffect.id === 'TANKY') dmg = Math.floor(dmg * 0.5);
                
                target.hp -= dmg; 
                spawnEffect(target.x, target.y, dmg);
                
                // Special Effect: Slow Aura on Hit
                if(target.specialEffect && target.specialEffect.id === 'SLOW_AURA') {
                    // Slow generic effect? Or slow hero? Let's just spawn text for feedback
                }
            }
            state.projectiles.splice(i, 1); 
        } 
        else { p.x += Math.cos(Math.atan2(dy, dx)) * p.speed; p.y += Math.sin(Math.atan2(dy, dx)) * p.speed; }
    }

    state.soldiers = state.soldiers.filter(s => s.hp > 0);
    
    for (let i = state.enemies.length - 1; i >= 0; i--) {
        if (state.enemies[i].hp <= 0) {
            const e = state.enemies[i];
            let reward = e.isBoss ? 100 : (e.isElite ? 20 : 5);
            if(e.type === 'elite_special') reward = 50;
            
            addGold(reward); spawnFloatingText(`+${reward}G`, e.x, e.y, 'yellow');

            const isSpawningFinished = state.enemiesToSpawn <= 0 && state.elitesToSpawn <= 0;
            const isBossWaveCleared = (state.waveNumber % 5 !== 0) || state.bossSpawnedInWave;
            if (state.enemies.length === 1 && isSpawningFinished && isBossWaveCleared) {
                const silverDrop = Math.floor(Math.random()*5)+1; addSilver(silverDrop); spawnFloatingText(`+${silverDrop} Bạc`, e.x, e.y-20, '#38b2ac', 30);
            }

            state.hero.xp++;
            if (state.hero.xp >= state.hero.reqXp) {
                state.hero.lvl++; state.hero.xp = 0; state.hero.reqXp += 10; 
                state.hero.dmg = Math.floor(state.hero.dmg * 1.2);
                state.hero.fireRate = Math.max(5, Math.floor(state.hero.fireRate / 1.1));
                spawnFloatingText("LEVEL UP!", state.hero.x, state.hero.y-50, '#63b3ed', 40);
                if (state.selectedEntity === state.hero) updateSelectionUI();
            }
            if (state.selectedEntity === state.hero) updateSelectionUI();
            if (state.selectedEntity === e) selectEntity(null);
            state.enemies.splice(i, 1);
        }
    }

    for (let i = state.particles.length - 1; i >= 0; i--) {
        const p = state.particles[i]; p.life--; p.y -= 0.5; if (p.life <= 0) state.particles.splice(i, 1);
    }
    
    if (state.selectedEntity && !state.paused) updateSelectionUI();
    updateSkillsUI();
    updateSummonUI();
}

function handleInput(e) {
    if (state.gameOver || !state.gameStarted) return;
    const rect = state.ctx.canvas.getBoundingClientRect();
    let clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
    let clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
    
    const scaleX = 1920 / rect.width;
    const scaleY = 1080 / rect.height;
    
    const x = (clientX - rect.left) * scaleX;
    const y = (clientY - rect.top) * scaleY;

    const heroDist = Math.hypot(x - state.hero.x, y - state.hero.y);
    if (heroDist < 60) { selectEntity(state.hero); return; }

    let clickedWeapon = false;
    for (let w of state.weapons) {
        if (x > w.x - w.width/2 && x < w.x + w.width/2 && y > w.y - w.height/2 && y < w.y + w.height/2) {
            selectEntity(w); clickedWeapon = true; return;
        }
    }
    if (clickedWeapon) return;

    for (let s of state.soldiers) { if (Math.hypot(x - s.x, y - s.y) < 40) { selectEntity(s); return; } }
    for (let en of state.enemies) { if (Math.hypot(x - en.x, y - en.y) < en.radius + 20) { selectEntity(en); return; } }
    if (x < CONFIG.WALL_X) { selectEntity(state.wallObj); return; }
    selectEntity(null);
}

function selectEntity(entity) {
    state.selectedEntity = entity;
    updateSelectionUI();
}

function updateSelectionUI() {
    const container = document.getElementById('info-panel-container');
    const icon = document.getElementById('sel-icon');
    const name = document.getElementById('sel-name');
    const info1 = document.getElementById('sel-info-1');
    const info2 = document.getElementById('sel-info-2');
    const info3 = document.getElementById('sel-info-3');
    const btn = document.getElementById('btn-upgrade');
    const heroXpContainer = document.getElementById('hero-xp-container');
    const heroXpBar = document.getElementById('hero-xp-bar');
    const heroXpText = document.getElementById('hero-xp-text');

    if (!state.selectedEntity) {
        container.classList.add('translate-y-20', 'opacity-0');
        setTimeout(() => container.classList.add('hidden'), 300);
        return;
    }
    container.classList.remove('hidden');
    requestAnimationFrame(() => container.classList.remove('translate-y-20', 'opacity-0'));

    const e = state.selectedEntity;
    heroXpContainer.classList.add('hidden'); heroXpText.classList.add('hidden'); icon.innerHTML = ''; btn.classList.remove('hidden');

    if (e.type === 'hero') {
        const hImg = imgAssets['hero'+state.currentHeroId];
        icon.innerHTML = `<img src="${hImg.src}" class="w-full h-full object-cover">`;
        heroXpContainer.classList.remove('hidden'); heroXpText.classList.remove('hidden');
        name.innerText = HERO_DB.find(h=>h.id===state.currentHeroId).name;
        info1.innerText = `Lvl: ${e.lvl}`; info2.innerText = `DMG: ${e.dmg}`; info3.innerText = `SPD: ${(60/e.fireRate).toFixed(1)}/s`;
        heroXpBar.style.width = `${(e.xp / e.reqXp) * 100}%`;
        heroXpText.innerText = `XP: ${e.xp}/${e.reqXp}`;
        btn.classList.add('hidden'); 
    } else if (e.type === 'wall') {
        icon.innerHTML = '<i class="fas fa-shield-alt text-green-400"></i>'; name.innerText = "Tường Thành";
        info1.innerText = `Lvl: ${e.lvl}`; info2.innerText = `HP: ${state.wallHp}/${state.maxWallHp}`;
        const cost = Math.floor(e.upgradeCost * Math.pow(1.5, e.lvl));
        btn.innerText = `Củng cố (${cost}G)`; btn.onclick = () => upgradeWall(e, cost); btn.disabled = state.gold < cost;
        if(btn.disabled) btn.classList.add('opacity-50'); else btn.classList.remove('opacity-50');
    } else if (e.type === 'weapon') {
        icon.innerHTML = '<i class="fas fa-cannon text-yellow-400"></i>';
        if (!e.bought) {
            name.innerText = `Trụ #${e.id + 1}`; info1.innerText = "Chưa mua";
            btn.innerText = `Mua (${e.upgradeCost}G)`; btn.onclick = () => buyWeapon(e); btn.disabled = state.gold < e.upgradeCost;
        } else {
            name.innerText = "Pháo Thần Công"; info1.innerText = `Lvl: ${e.lvl}`; info2.innerText = `DMG: ${e.dmg}`;
            const cost = Math.floor(e.upgradeCost * Math.pow(1.6, e.lvl));
            btn.innerText = `Nâng cấp (${cost}G)`; btn.onclick = () => upgradeWeapon(e, cost); btn.disabled = state.gold < cost;
        }
        if(btn.disabled) btn.classList.add('opacity-50'); else btn.classList.remove('opacity-50');
    } else {
        let imgUrl = CONFIG.IMAGES.normal;
        if(e.type === 'soldier') imgUrl = CONFIG.IMAGES.soldier;
        else if(e.type === 'barricade') imgUrl = ""; // No image for now, just render rect
        else if(e.type === 'boss') imgUrl = CONFIG.IMAGES.boss;
        else if(e.type.includes('elite')) imgUrl = CONFIG.IMAGES.elite;

        if (e.type === 'barricade') {
             icon.innerHTML = '<i class="fas fa-road-spikes text-3xl text-yellow-600"></i>';
             name.innerText = "Hàng Rào";
        } else {
             icon.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover">`;
             name.innerText = e.type === 'soldier' ? "Binh Lính" : (e.type === 'boss' ? "BOSS" : (e.type === 'elite_special' ? e.specialEffect.name : (e.type.includes('elite') ? "Tinh Anh" : "Quái")));
        }
        
        info1.innerText = `HP: ${Math.ceil(e.hp)}/${e.maxHp}`; info2.innerText = `DMG: ${e.dmg||0}`;
        btn.classList.add('hidden');
    }
}

// Helpers for Upgrades
function buyWeapon(w) { if (state.gold >= w.upgradeCost) { state.gold -= w.upgradeCost; w.bought = true; w.lvl = 1; w.dmg = w.baseDmg; updateUI(); updateSelectionUI(); spawnFloatingText("ĐÃ MUA!", w.x, w.y, '#ecc94b'); } }
function upgradeWeapon(w, cost) { if (state.gold >= cost) { state.gold -= cost; w.lvl++; w.dmg = Math.floor(w.dmg * 1.3); w.fireRate = Math.max(10, Math.floor(w.fireRate / 1.1)); w.range = Math.floor(w.range * 1.1); updateUI(); updateSelectionUI(); spawnFloatingText("UPGRADED!", w.x, w.y, '#ecc94b'); } }
function upgradeHero(cost) { if (state.gold >= cost) { state.gold -= cost; state.hero.lvl++; state.hero.dmg = Math.floor(state.hero.dmg * 1.2); updateUI(); updateSelectionUI(); spawnFloatingText("TRAINED!", state.hero.x, state.hero.y, '#63b3ed'); } }
function upgradeWall(wObj, cost) { if (state.gold >= cost) { state.gold -= cost; wObj.lvl++; state.maxWallHp = Math.floor(state.maxWallHp * 1.2); state.wallHp = state.maxWallHp; updateUI(); updateSelectionUI(); spawnFloatingText("WALL UP!", CONFIG.WALL_X/2, state.height/2, '#48bb78', 24); } }

// --- SKILLS ---
function summonSoldier() {
    if (state.soldiers.filter(s => s.type === 'soldier').length >= 20) {
        spawnFloatingText("MAX LÍNH!", CONFIG.WALL_X, state.height/2, 'red', 20);
        return;
    }
    if (state.summonCooldown > 0 || state.gold < state.summonCost) return;
    
    state.gold -= state.summonCost;
    state.summonCost += 1; 
    state.summonCooldown = state.summonCooldownMax;
    
    const count = Math.floor(Math.random() * 2) + 2; 
    for(let i=0; i<count; i++) spawnSingleSoldier();
    updateUI();
}

function activateBarricade() {
    if (state.barricadeCooldown > 0 || state.gold < 20) return;
    state.gold -= 20;
    state.barricadeCooldown = state.barricadeCooldownMax;
    
    // Logic: Find the right-most enemy to block, else spawn near wall
    let targetX = CONFIG.WALL_X + 200;
    let maxX = 0;
    state.enemies.forEach(e => { if(e.x > maxX && e.x < state.width - 200) maxX = e.x; });
    
    if (maxX > 0) targetX = Math.max(CONFIG.WALL_X + 150, maxX - 150);
    
    const hp = 50 + (state.waveNumber * 5);
    state.soldiers.push({ 
        type: 'barricade', x: targetX, y: (state.height / 2), 
        radius: 40, hp: hp, maxHp: hp, dmg: 0, speed: 0, attackCooldown: 0, facingLeft: false 
    });
    spawnFloatingText("CHẶN ĐƯỜNG!", targetX, state.height/2 - 50, "#d69e2e", 24);
    updateUI();
}

function activateFrenzy() {
    if (state.frenzyCooldown > 0 || state.gold < 30) return;
    state.gold -= 30;
    state.frenzyCooldown = state.frenzyCooldownMax;
    state.frenzyActiveTimer = 900; // 15s * 60fps
    spawnFloatingText("TỐC CHIẾN!", state.width/2, state.height/2, "red", 40);
    updateUI();
}

function spawnSingleSoldier(free = false) { 
    const waveMultiplier = Math.pow(1.05, state.waveNumber - 1); 
    const baseHp = 100; const baseDmgMin = 2; const baseDmgMax = 3; 
    const scaledHp = Math.floor(baseHp * waveMultiplier); 
    const scaledDmg = Math.floor((Math.random() * (baseDmgMax - baseDmgMin + 1) + baseDmgMin) * waveMultiplier); 
    state.soldiers.push({ type: 'soldier', x: CONFIG.WALL_X, y: (state.height / 2) + (Math.random() * 120 - 60), radius: 30, hp: scaledHp, maxHp: scaledHp, dmg: scaledDmg, speed: 1.5, attackCooldown: 0, facingLeft: false }); 
}

function takeWallDamage(amount) { state.wallHp -= amount; document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 500); updateUI(); if (state.wallHp <= 0) { state.wallHp = 0; gameOver(); } }
function addGold(amount) { state.gold += amount; updateUI(); if (state.selectedEntity) updateSelectionUI(); }
function addSilver(amount) { state.silver += amount; localStorage.setItem('iw_silver', state.silver); updateUI(); }
function spawnFloatingText(text, x, y, color, size=16) { state.particles.push({ type: 'text', text: text, x: x, y: y, color: color, life: 60 }); }
function spawnEffect(x, y, text) { state.particles.push({ type: 'effect', text: text, x: x, y: y, color: 'white', life: 20 }); }

function updateUI() { 
    document.getElementById('ui-gold').innerText = state.gold; 
    document.getElementById('ui-wave').innerText = state.waveNumber; 
    const wallHpEl = document.getElementById('ui-wall-hp'); if(wallHpEl) wallHpEl.innerText = Math.max(0, state.wallHp); 
    const maxWallHpEl = document.getElementById('ui-max-wall-hp'); if(maxWallHpEl) maxWallHpEl.innerText = state.maxWallHp; 
    document.getElementById('ui-silver').innerText = state.silver; 
    
    updateSummonUI();
}

function updateSummonUI() {
    const summonBtn = document.getElementById('btn-summon');
    const summonCostDisplay = document.getElementById('summon-cost-display');
    const soldierCountDisplay = document.getElementById('soldier-count-display');
    const summonOverlay = document.getElementById('summon-overlay');
    
    if(summonCostDisplay) summonCostDisplay.innerText = state.summonCost + "G";
    if(soldierCountDisplay) soldierCountDisplay.innerText = state.soldiers.filter(s=>s.type==='soldier').length + "/20";
    
    if (state.summonCooldown > 0) {
        summonBtn.disabled = true;
        summonOverlay.style.display = 'flex';
        summonOverlay.innerText = Math.ceil(state.summonCooldown / 60);
    } else {
        summonOverlay.style.display = 'none';
        if (state.gold < state.summonCost || state.soldiers.filter(s=>s.type==='soldier').length >= 20) {
            summonBtn.disabled = true;
        } else {
            summonBtn.disabled = false;
        }
    }
}

function updateSkillsUI() {
    // Barricade
    const barBtn = document.getElementById('btn-barricade');
    const barOverlay = document.getElementById('barricade-overlay');
    if (state.barricadeCooldown > 0) {
        barBtn.disabled = true; barOverlay.style.display = 'flex'; barOverlay.innerText = Math.ceil(state.barricadeCooldown/60);
    } else {
        barOverlay.style.display = 'none';
        barBtn.disabled = state.gold < 20;
    }

    // Frenzy
    const frenzyBtn = document.getElementById('btn-frenzy');
    const frenzyOverlay = document.getElementById('frenzy-overlay-timer');
    if (state.frenzyCooldown > 0) {
        frenzyBtn.disabled = true; frenzyOverlay.style.display = 'flex'; frenzyOverlay.innerText = Math.ceil(state.frenzyCooldown/60);
    } else {
        frenzyOverlay.style.display = 'none';
        frenzyBtn.disabled = state.gold < 30;
    }
}

function togglePause() { state.paused = !state.paused; document.getElementById('btn-pause').innerHTML = state.paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>'; }
function gameOver() {
    state.gameOver = true;
    document.getElementById('final-wave').innerText = state.waveNumber;
    document.getElementById('game-over-screen').classList.remove('hidden');
    document.getElementById('skills-ui').classList.add('hidden');
    document.getElementById('info-panel-container').classList.add('hidden');
    document.getElementById('btn-surrender').classList.add('hidden');
    document.getElementById('btn-pause').classList.add('hidden');
    document.getElementById('btn-speed').classList.add('hidden');
    document.getElementById('ingame-stats').classList.add('hidden');
    document.getElementById('ui-timer').classList.add('hidden');
    document.getElementById('btn-skip').classList.add('hidden');
}

function triggerHeroSkills() {
    const id = state.currentHeroId;
    const heroColor = HERO_DB.find(h=>h.id===id)?.color || 'white';
    
    // Skill Trigger Logic
    switch(id) {
        case 0: // Starter: 50% Summon / 50% Crit
            if(Math.random()<0.5) { spawnSingleSoldier(true); spawnFloatingText("VIỆN BINH!", state.hero.x, state.hero.y-20, "#48bb78", 20); }
            else { state.hero.nextAttackCrit = true; spawnFloatingText("CHÍ MẠNG!", state.hero.x, state.hero.y-20, "#ff0000", 20); }
            break;
        case 1: // Archer: Speed
            state.hero.speedBuffTimer = 300; spawnFloatingText("TỐC ĐỘ!", state.hero.x, state.hero.y-20, heroColor, 20);
            break;
        case 2: // Fire: AoE
            state.hero.nextAttackAoE = true; spawnFloatingText("BÙM!", state.hero.x, state.hero.y-20, heroColor, 20);
            break;
        case 3: // Assassin: Crit x3
            state.hero.nextAttackCrit = true; spawnFloatingText("SÁT THỦ!", state.hero.x, state.hero.y-20, heroColor, 20);
            break;
        case 4: // Engineer: Repair
            state.wallHp = Math.min(state.maxWallHp, state.wallHp + 50); spawnFloatingText("+50 HP", CONFIG.WALL_X, state.height/2, heroColor, 20);
            break;
        case 5: // Warrior: Knockback
            state.hero.nextAttackKnockback = true; spawnFloatingText("ĐẨY LÙI!", state.hero.x, state.hero.y-20, heroColor, 20);
            break;
        case 6: // Thief: Gold
            state.hero.nextAttackGold = true; spawnFloatingText("CƯỚP!", state.hero.x, state.hero.y-20, heroColor, 20);
            break;
        case 7: // Ice: Slow
            state.hero.nextAttackSlow = true; spawnFloatingText("ĐÓNG BĂNG!", state.hero.x, state.hero.y-20, heroColor, 20);
            break;
        case 8: // Summoner: 2 Soldiers
            spawnSingleSoldier(true); spawnSingleSoldier(true); spawnFloatingText("TRIỆU HỒI!", state.hero.x, state.hero.y-20, heroColor, 20);
            break;
        case 9: // Sniper: Pierce/Range
            state.hero.nextAttackPierce = true; spawnFloatingText("XUYÊN!", state.hero.x, state.hero.y-20, heroColor, 20);
            break;
        case 10: // Pirate: Big Dmg (Crit x5)
            state.hero.nextAttackCrit = true; spawnFloatingText("PHÁO!", state.hero.x, state.hero.y-20, heroColor, 20);
            break;
    }
}

function drawEntity(ctx, entity, img, x, y, radius, isAttackFrame) {
    ctx.save(); ctx.translate(x, y);
    if (entity.facingLeft) ctx.scale(-1, 1);
    
    // Base scale calculation
    let scale = isAttackFrame > 0 ? 1.2 : 1 + 0.05 * Math.sin(performance.now() * 0.005);

    // Apply 1.2x size multiplier for Hero and Enemies (Quái, Tướng)
    let sizeMultiplier = 1;
    // Check if it's Hero OR any type of Enemy (normal, boss, elites)
    // We assume anything that is NOT a soldier/barricade/weapon is an enemy/hero.
    // Explicit checks:
    if (entity.type === 'hero' || 
        ['normal', 'elite', 'boss', 'ranged', 'elite_tank', 'elite_speed', 'elite_special'].includes(entity.type) || 
        (entity.type && entity.type.includes('elite'))) {
        sizeMultiplier = 1.2;
    }
    
    ctx.scale(scale * sizeMultiplier, scale * sizeMultiplier);
    
    // Feature 2: Special Elite Glow
    if (entity.type === 'elite_special') {
        ctx.shadowBlur = 20;
        ctx.shadowColor = entity.specialEffect.color;
    }

    // Use imgAssets mapping
    let useImg = img;
    if (entity.type === 'hero' && state.currentHeroId !== 0) {
        useImg = imgAssets['hero'+state.currentHeroId];
    }

    if (entity.type === 'barricade') {
        // Draw Barricade (Spikes)
        ctx.fillStyle = '#d69e2e';
        ctx.beginPath();
        ctx.moveTo(-20, 20); ctx.lineTo(0, -20); ctx.lineTo(20, 20);
        ctx.moveTo(-10, 20); ctx.lineTo(10, -15); ctx.lineTo(30, 20);
        ctx.fill();
        // Reset Shadow
        ctx.shadowBlur = 0;
    } 
    else if (useImg && useImg.complete && useImg.naturalWidth !== 0) {
        const aspect = useImg.naturalWidth / useImg.naturalHeight;
        let w = radius * 2; let h = radius * 2;
        if (aspect > 1) h = w / aspect; else w = h * aspect;
        ctx.drawImage(useImg, -w/2, -h/2, w, h);
        // Reset Shadow
        ctx.shadowBlur = 0;
    } else {
        ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.fillStyle = entity.color || 'white'; ctx.fill();
        ctx.shadowBlur = 0;
        if(entity.type === 'hero') {
            ctx.fillStyle = 'white'; ctx.font = 'bold 16px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText("H"+state.currentHeroId, 0, 0);
        }
    }
    ctx.restore();
}

function draw() {
    const ctx = state.ctx; ctx.clearRect(0, 0, state.width, state.height);
    const bgImg = (state.bgIndex === 0) ? imgAssets.bg1 : imgAssets.bg2;
    if (bgImg && bgImg.complete && bgImg.naturalWidth !== 0) {
        ctx.save(); const areaX = CONFIG.WALL_X; const areaWidth = state.width - areaX;
        ctx.translate(areaX + areaWidth/2, state.height/2); ctx.rotate(90 * Math.PI / 180);
        ctx.drawImage(bgImg, -state.height/2, -areaWidth/2, state.height, areaWidth); ctx.restore();
    } else { ctx.fillStyle = '#2d3748'; ctx.fillRect(CONFIG.WALL_X, 0, state.width, state.height); }

    ctx.fillStyle = (state.selectedEntity && state.selectedEntity.type === 'wall') ? CONFIG.COLORS.wallHighlight : '#1a202c';
    ctx.fillRect(0, 0, CONFIG.WALL_X, state.height);
    const hpPercent = state.wallHp / state.maxWallHp;
    ctx.fillStyle = hpPercent > 0.5 ? '#48bb78' : '#f56565'; ctx.fillRect(0, state.height - 10, CONFIG.WALL_X * hpPercent, 10);

    state.weapons.forEach(w => {
        ctx.strokeStyle = '#718096'; ctx.lineWidth = 2;
        ctx.strokeRect(w.x - w.width/2, w.y - w.height/2, w.width, w.height);
        if (w.bought) {
            ctx.fillStyle = '#ecc94b'; ctx.fillRect(w.x - 15, w.y - 15, 30, 30);
            const barrelOffset = w.animTimer > 0 ? -5 : 0;
            ctx.fillStyle = '#d69e2e'; ctx.fillRect(w.x + barrelOffset, w.y - 5, 20, 10);
            ctx.fillStyle = 'white'; ctx.font = '20px Arial'; ctx.fillText(`Lvl ${w.lvl}`, w.x - 12, w.y + 25);
        } else { ctx.fillStyle = '#4a5568'; ctx.font = '40px Arial'; ctx.fillText('+', w.x - 12, w.y + 12); }
        if (state.selectedEntity === w) { ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.strokeRect(w.x - w.width/2 - 5, w.y - w.height/2 - 5, w.width + 10, w.height + 10); }
    });

    drawEntity(ctx, state.hero, imgAssets.hero, state.hero.x, state.hero.y, 60, state.hero.animTimer); 
    
    state.soldiers.forEach(s => { 
        drawEntity(ctx, s, imgAssets.soldier, s.x, s.y, s.radius, 0); 
        ctx.fillStyle='red'; ctx.fillRect(s.x-15, s.y-s.radius-10, 30, 6); ctx.fillStyle='#68d391'; ctx.fillRect(s.x-15, s.y-s.radius-10, 30*(s.hp/s.maxHp), 6); 
    });
    
    state.enemies.forEach(e => { 
        let img = imgAssets.normal; 
        if (e.type.includes('elite')) img = imgAssets.elite; 
        if (e.type === 'boss') img = imgAssets.boss;
        drawEntity(ctx, e, img, e.x, e.y, e.radius, e.animTimer);
        ctx.fillStyle='red'; ctx.fillRect(e.x-20, e.y-e.radius-10, 40, 6); ctx.fillStyle='#68d391'; ctx.fillRect(e.x-20, e.y-e.radius-10, 40*(e.hp/e.maxHp), 6);
    });
    
    state.projectiles.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fillStyle=p.color; ctx.fill(); });
    state.particles.forEach(p => { if(p.type==='text') { ctx.fillStyle=p.color; ctx.font='bold 24px Arial'; ctx.fillText(p.text,p.x,p.y); } else { ctx.fillStyle='white'; ctx.font='bold 30px Arial'; ctx.fillText(p.text,p.x,p.y); } });
}

// Start
initGame();
</script>
</body>
</html>
